require=function(){return function e(t,s,i){function r(a,o){if(!s[a]){if(!t[a]){var d="function"==typeof require&&require;if(!o&&d)return d(a,!0);if(n)return n(a,!0);var h=new Error("Cannot find module '"+a+"'");throw h.code="MODULE_NOT_FOUND",h}var g=s[a]={exports:{}};t[a][0].call(g.exports,function(e){return r(t[a][1][e]||e)},g,g.exports,e,t,s,i)}return s[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}}()({1:[function(e,t,s){window.p2pml||(window.p2pml={}),window.p2pml.shaka=e("p2p-media-loader-shaka")},{"p2p-media-loader-shaka":"p2p-media-loader-shaka"}],2:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(r,n){function a(e){try{d(i.next(e))}catch(e){n(e)}}function o(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){e.done?r(e.value):new s(function(t){t(e.value)}).then(a,o)}d((i=i.apply(e,t||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const r=e("events"),n=e("p2p-media-loader-core"),a=e("./segment-manager"),o=e("./integration");s.Engine=class extends r.EventEmitter{static isSupported(){return n.HybridLoader.isSupported()}constructor(e={}){super(),this.loader=new n.HybridLoader(e.loader),this.segmentManager=new a.SegmentManager(this.loader,e.segments),Object.keys(n.Events).map(e=>n.Events[e]).forEach(e=>this.loader.on(e,(...t)=>this.emit(e,...t)))}destroy(){return i(this,void 0,void 0,function*(){yield this.segmentManager.destroy()})}getSettings(){return{segments:this.segmentManager.getSettings(),loader:this.loader.getSettings()}}getDetails(){return{loader:this.loader.getDetails()}}initShakaPlayer(e){o.initShakaPlayer(e,this.segmentManager)}}},{"./integration":3,"./segment-manager":6,events:"events","p2p-media-loader-core":"p2p-media-loader-core"}],3:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(r,n){function a(e){try{d(i.next(e))}catch(e){n(e)}}function o(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){e.done?r(e.value):new s(function(t){t(e.value)}).then(a,o)}d((i=i.apply(e,t||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const r=e("debug"),n=e("./manifest-parser-proxy"),a=e("./utils"),o=r("p2pml:shaka:index");function d(e,t,s){if(!t.p2pml)return shaka.net.HttpXHRPlugin(e,t,s);const{player:r,segmentManager:n}=t.p2pml;let d,g,u,l=n.getSettings().assetsStorage;void 0!==l&&void 0!==r.getNetworkingEngine().p2pml&&void 0!==r.getNetworkingEngine().p2pml.masterManifestUri?(d=r.getNetworkingEngine().p2pml.masterManifestUri,g=a.getMasterSwarmId(d,n.getSettings())):l=void 0;const c=r.getManifest();if(s===shaka.net.NetworkingEngine.RequestType.SEGMENT&&null!==c&&void 0!==c.p2pml&&void 0!==c.p2pml.parser&&(u=c.p2pml.parser.find(e,t.headers.Range)),void 0!==u&&"video"===u.streamType){o("request","load",u.identity);const e=n.load(u,a.getSchemedUri(r.getManifestUri()),h(r)),t=()=>i(this,void 0,void 0,function*(){o("request","abort",u.identity)});return new shaka.util.AbortableOperation(e,t)}if(l){const r=(()=>i(this,void 0,void 0,function*(){const i=yield l.getAsset(e,t.headers.Range,g);if(void 0!==i)return{data:i.data,uri:i.responseUri,fromCache:!0};{const i=yield shaka.net.HttpXHRPlugin(e,t,s).promise;return l.storeAsset({masterManifestUri:d,masterSwarmId:g,requestUri:e,requestRange:t.headers.Range,responseUri:i.uri,data:i.data}),i}}))();return new shaka.util.AbortableOperation(r,()=>i(this,void 0,void 0,function*(){}))}return shaka.net.HttpXHRPlugin(e,t,s)}function h(e){let t=0;const s=e.getPlayheadTimeAsDate();return s&&(t=s.valueOf(),e.isLive()&&(t-=e.getPresentationStartTimeAsDate().valueOf()),t/=1e3),t}s.initShakaPlayer=function(e,t){o("register parser proxies"),shaka.media.ManifestParser.registerParserByExtension("mpd",n.ShakaDashManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/dash+xml",n.ShakaDashManifestParserProxy),shaka.media.ManifestParser.registerParserByExtension("m3u8",n.ShakaHlsManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/x-mpegurl",n.ShakaHlsManifestParserProxy),shaka.media.ManifestParser.registerParserByMime("application/vnd.apple.mpegurl",n.ShakaHlsManifestParserProxy),o("init networking engine"),shaka.net.NetworkingEngine.registerScheme("http",d),shaka.net.NetworkingEngine.registerScheme("https",d);let s=0,r=0;e.addEventListener("loading",()=>i(this,void 0,void 0,function*(){s>0&&(clearInterval(s),s=0),r=0;const i=e.getManifest();i&&i.p2pml&&i.p2pml.parser.reset(),yield t.destroy(),s=setInterval(()=>{const s=h(e);(s!==r||e.isBuffering())&&(t.setPlayheadTime(s),r=s)},500)})),o("register request filter"),e.getNetworkingEngine().registerRequestFilter((s,i)=>{i.p2pml={player:e,segmentManager:t}})}},{"./manifest-parser-proxy":4,"./utils":7,debug:"debug"}],4:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=e("./parser-segment");class r{constructor(e){this.cache=new i.ParserSegmentCache(200),this.originalManifestParser=e}isHls(){return this.originalManifestParser instanceof shaka.hls.HlsParser}isDash(){return this.originalManifestParser instanceof shaka.dash.DashParser}start(e,t){return void 0===t.networkingEngine.p2pml&&(t.networkingEngine.p2pml={}),t.networkingEngine.p2pml.masterManifestUri=e,this.originalManifestParser.start(e,t).then(e=>{this.manifest=e;for(const t of e.periods){const e=[];for(const s of t.variants)null!=s.video&&-1==e.indexOf(s.video)&&(this.hookGetSegmentReference(s.video),e.push(s.video)),null!=s.audio&&-1==e.indexOf(s.audio)&&(this.hookGetSegmentReference(s.audio),e.push(s.audio))}return e.p2pml={parser:this},e})}configure(e){return this.originalManifestParser.configure(e)}stop(){return this.originalManifestParser.stop()}update(){return this.originalManifestParser.update()}onExpirationUpdated(){return this.originalManifestParser.onExpirationUpdated()}find(e,t){return this.cache.find(e,t)}reset(){this.cache.clear()}hookGetSegmentReference(e){e.getSegmentReferenceOriginal=e.getSegmentReference,e.getSegmentReference=(t=>(this.cache.add(e,t),e.getSegmentReferenceOriginal(t))),e.getPosition=(()=>this.isHls()&&"video"===e.type?this.manifest.periods[0].variants.reduce((e,t)=>(t.video&&t.video.id&&!e.includes(t.video.id)&&e.push(t.video.id),e),[]).indexOf(e.id):-1)}}s.ShakaManifestParserProxy=r;s.ShakaDashManifestParserProxy=class extends r{constructor(){super(new shaka.dash.DashParser)}};s.ShakaHlsManifestParserProxy=class extends r{constructor(){super(new shaka.hls.HlsParser)}}},{"./parser-segment":5}],5:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0});const i=e("./utils");class r{constructor(e,t,s,i,r,n,a,o,d,h,g,u){this.streamId=e,this.streamType=t,this.streamPosition=s,this.streamIdentity=i,this.identity=r,this.position=n,this.start=a,this.end=o,this.uri=d,this.range=h,this.prev=g,this.next=u}static create(e,t){const s=e.getSegmentReferenceOriginal(t);if(!s)return;const n=s.createUris();if(!n||0===n.length)return;const a=s.getStartTime(),o=s.getEndTime(),d=s.getStartByte(),h=s.getEndByte(),g=d||h?`bytes=${d||""}-${h||""}`:void 0,u=e.type.substring(0,1).toUpperCase(),l=e.getPosition(),c=l>=0,m=c?`${u}${l}`:`${u}${e.id}`,p=c?`${t}`:`${Number(a).toFixed(3)}`;return new r(e.id,e.type,l,m,p,t,a,o,i.getSchemedUri(n[0]),g,()=>r.create(e,t-1),()=>r.create(e,t+1))}}s.ParserSegment=r;s.ParserSegmentCache=class{constructor(e){this.segments=[],this.maxSegments=e}find(e,t){return this.segments.find(s=>s.uri===e&&s.range===t)}add(e,t){const s=r.create(e,t);s&&!this.find(s.uri,s.range)&&(this.segments.push(s),this.segments.length>this.maxSegments&&this.segments.splice(0,.2*this.maxSegments))}clear(){this.segments.splice(0)}}},{"./utils":7}],6:[function(e,t,s){"use strict";var i=this&&this.__awaiter||function(e,t,s,i){return new(s||(s=Promise))(function(r,n){function a(e){try{d(i.next(e))}catch(e){n(e)}}function o(e){try{d(i.throw(e))}catch(e){n(e)}}function d(e){e.done?r(e.value):new s(function(t){t(e.value)}).then(a,o)}d((i=i.apply(e,t||[])).next())})};Object.defineProperty(s,"__esModule",{value:!0});const r=e("debug"),n=e("p2p-media-loader-core"),a=e("./utils"),o={forwardSegmentCount:20,maxHistorySegments:50,swarmId:void 0,assetsStorage:void 0};s.SegmentManager=class{constructor(e,t={}){this.debug=r("p2pml:shaka:sm"),this.requests=new Map,this.manifestUri="",this.playheadTime=0,this.segmentHistory=[],this.onSegmentLoaded=(e=>{this.requests.has(e.id)&&(this.reportSuccess(this.requests.get(e.id),e),this.debug("request delete",e.id),this.requests.delete(e.id))}),this.onSegmentError=((e,t)=>{this.requests.has(e.id)&&(this.reportError(this.requests.get(e.id),t),this.debug("request delete from error",e.id),this.requests.delete(e.id))}),this.onSegmentAbort=(e=>{this.requests.has(e.id)&&(this.reportError(this.requests.get(e.id),"Internal abort"),this.debug("request delete from abort",e.id),this.requests.delete(e.id))}),this.settings=Object.assign({},o,t),this.loader=e,this.loader.on(n.Events.SegmentLoaded,this.onSegmentLoaded),this.loader.on(n.Events.SegmentError,this.onSegmentError),this.loader.on(n.Events.SegmentAbort,this.onSegmentAbort)}destroy(){return i(this,void 0,void 0,function*(){0!==this.requests.size&&(console.error("Destroying segment manager with active request(s)!"),this.requests.clear()),this.playheadTime=0,this.segmentHistory.splice(0),void 0!==this.settings.assetsStorage&&(yield this.settings.assetsStorage.destroy()),yield this.loader.destroy()})}getSettings(){return this.settings}load(e,t,s){return i(this,void 0,void 0,function*(){this.manifestUri=t,this.playheadTime=s,this.pushSegmentHistory(e);const i=this.refreshLoad(),r=yield this.loader.getSegment(i.id);return new Promise((e,t)=>{const s=new d(i.id,e,t);r?this.reportSuccess(s,r):(this.debug("request add",s.id),this.requests.set(s.id,s))})})}setPlayheadTime(e){this.playheadTime=e,this.segmentHistory.length>0&&this.refreshLoad()}refreshLoad(){const e=this.segmentHistory[this.segmentHistory.length-1],t=this.playheadTime>.1?this.playheadTime:e.start,s=this.segmentHistory.reduce((e,s)=>(s.start>=t&&e.push(s),e),[]);0===s.length&&s.push(e);const i=s.length-1;do{const e=s[s.length-1].next();if(!e)break;s.push(e)}while(s.length<this.settings.forwardSegmentCount);const r=a.getMasterSwarmId(this.manifestUri,this.settings),o=s.map((e,t)=>new n.Segment(`${r}+${e.streamIdentity}+${e.identity}`,e.uri,r,this.manifestUri,e.streamIdentity,e.identity,e.range,t));return this.loader.load(o,`${r}+${e.streamIdentity}`),o[i]}pushSegmentHistory(e){this.segmentHistory.length>=this.settings.maxHistorySegments&&(this.debug("segment history auto shrink"),this.segmentHistory.splice(0,.2*this.settings.maxHistorySegments)),this.segmentHistory.length>0&&this.segmentHistory[this.segmentHistory.length-1].start>e.start&&(this.debug("segment history reset due to playhead seek back"),this.segmentHistory.splice(0)),this.segmentHistory.push(e)}reportSuccess(e,t){let s=void 0;t.downloadBandwidth>0&&t.data&&t.data.byteLength>0&&(s=Math.trunc(t.data.byteLength/t.downloadBandwidth)),this.debug("report success",e.id),e.resolve({data:t.data,timeMs:s})}reportError(e,t){e.reject&&(this.debug("report error",e.id),e.reject(t))}};class d{constructor(e,t,s){this.id=e,this.resolve=t,this.reject=s}}},{"./utils":7,debug:"debug","p2p-media-loader-core":"p2p-media-loader-core"}],7:[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.getSchemedUri=function(e){return e.startsWith("//")?window.location.protocol+e:e},s.getMasterSwarmId=function(e,t){return t.swarmId&&0!==t.swarmId.length?t.swarmId:e.split("?")[0]}},{}],"p2p-media-loader-shaka":[function(e,t,s){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.version="undefined"==typeof __P2PML_VERSION__?"0.5.0":__P2PML_VERSION__;var i=e("./engine");s.Engine=i.Engine},{"./engine":2}]},{},[1]);
